Write-Host "ğŸ”º Sistema Triangular 360Â° â€” Modo Adaptive Iniciado..." -ForegroundColor Cyan

# ==== ğŸ” Senha segura =========================================================
$senhaArquivo = "$env:APPDATA\supabase_cred.key"
if (-not (Test-Path $senhaArquivo)) {
    Write-Host "ğŸ”‘ Criando nova credencial segura..."
    $senha = Read-Host "Digite sua senha do banco Supabase (ex: 36@Artropodes)" -AsSecureString
    $senha | ConvertFrom-SecureString | Out-File $senhaArquivo
}
$senha = Get-Content $senhaArquivo | ConvertTo-SecureString
$BSTR = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($senha)
$senhaPura = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($BSTR)
$senhaCodificada = [uri]::EscapeDataString($senhaPura)

# ==== ğŸŒ ConfiguraÃ§Ã£o =========================================================
$DB_URL = "db.kpzzekflqpoeccnqfkng.supabase.co"
$PSQL_PATH = "C:\Program Files\PostgreSQL\17\bin\psql.exe"
$LOG_FILE = "C:\Users\Administrador\pecuariatech\tri360_secure_log.txt"
$connectionString = "postgresql://postgres:$senhaCodificada@$DB_URL:5432/postgres"

# ==== ğŸ§  1ï¸âƒ£ VerificaÃ§Ã£o de ambiente ==========================================
Write-Host "ğŸ§  [1/4] DiagnÃ³stico do ambiente..."
if (-not (Test-Path $PSQL_PATH)) {
    Write-Host "âš™ï¸ Instalando cliente PostgreSQL..." -ForegroundColor Yellow
    winget install --source winget PostgreSQL.PostgreSQL.17
}
$env:PATH += ";C:\Program Files\PostgreSQL\17\bin"

# ==== ğŸŒ 2ï¸âƒ£ ConexÃ£o ==========================================================
Write-Host "ğŸŒ [2/4] Testando conexÃ£o com Supabase..."
try {
    $test = & $PSQL_PATH $connectionString -c "SELECT version();" 2>&1
    if ($test -match "PostgreSQL") { Write-Host "âœ… Conectado ao Supabase." }
    else { throw "Falha: $test" }
}
catch {
    Write-Host "âŒ Erro ao conectar. Verifique credenciais ou rede." -ForegroundColor Red
    exit
}

# ==== ğŸ§© 3ï¸âƒ£ CriaÃ§Ã£o e sincronizaÃ§Ã£o ==========================================
Write-Host "ğŸ§© [3/4] Verificando e criando tabela logs_reparo..."
$sql = @"
create table if not exists public.logs_reparo (
  id bigint generated by default as identity primary key,
  data_execucao timestamptz default now(),
  arquivos_verificados int,
  arquivos_corrigidos int,
  arquivos_padronizados int,
  mensagem text,
  sucesso boolean default true
);
alter table public.logs_reparo enable row level security;
drop policy if exists "Permitir insercoes via API" on public.logs_reparo;
create policy "Permitir insercoes via API"
on public.logs_reparo
for insert
to public
with check (true);
"@
& $PSQL_PATH $connectionString -c $sql
Write-Host "âœ… Tabela verificada e ativa." -ForegroundColor Green

# ==== ğŸ“‘ 4ï¸âƒ£ Log adaptativo ===================================================
if (-not (Test-Path $LOG_FILE)) {
    Write-Host "ğŸ§¾ Criando log inicial..."
    New-Item -Path $LOG_FILE -ItemType File -Force | Out-Null
}
$mensagem = "Tri360-Adaptive executado com sucesso em $(Get-Date)"
Add-Content $LOG_FILE $mensagem

# Recalcula hash apÃ³s criaÃ§Ã£o
$hash = (Get-FileHash $LOG_FILE -Algorithm SHA256).Hash
Add-Content $LOG_FILE "Hash SHA256: $hash"

Write-Host "ğŸ“ Log atualizado em: $LOG_FILE" -ForegroundColor Yellow
Write-Host "ğŸ”º Sistema Triangular 360Â° â€” Adaptive concluÃ­do com sucesso." -ForegroundColor Cyan
