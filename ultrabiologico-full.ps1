# Script: ultrabiologico-full.ps1
# Objetivo: Colocar PecuariaTech ultrabiol√≥gico online, com monitoramento, alertas WhatsApp e GPS integrado.

param(
    [string]$Domain = "pecuariatech.com",
    [string]$Project = "pecuariatech",
    [string]$WhatsAppToken = "<SEU_TOKEN_META>",
    [string]$PhoneNumberId = "<SEU_PHONE_NUMBER_ID>",
    [string]$To = "5567999564560"   # Seu n√∫mero com DDI
)

# Fun√ß√£o de log com timestamp
function Write-Stamp($Message) {
    Write-Host "$(Get-Date -Format 'HH:mm:ss') $Message"
}

# 1Ô∏è‚É£ Build e deploy Next.js no Vercel
Write-Stamp "üîß Rodando build e deploy no Vercel..."
npm install
npm run build
vercel --prod
Write-Stamp "‚úÖ Deploy conclu√≠do."

# 2Ô∏è‚É£ Configurar dom√≠nio e SSL
Write-Stamp "üåê Configurando dom√≠nio $Domain..."
vercel domains add $Domain --yes
vercel domains add "www.$Domain" --yes
vercel alias set $Project "www.$Domain" --yes

# Fun√ß√£o para checar DNS
function Test-DNS {
    param([string]$d)
    try {
        $records = (Resolve-DnsName $d -Type CNAME -ErrorAction Stop).NameHost
        return $records -like "*vercel-dns.com"
    } catch {
        return $false
    }
}

$dnsOk = $false
for ($i=0; $i -lt 30; $i++) {
    if (Test-DNS "www.$Domain") {
        Write-Stamp "‚úÖ DNS j√° aponta para Vercel."
        $dnsOk = $true
        break
    } else {
        Write-Stamp "‚è≥ Aguardando propaga√ß√£o DNS... (tentativa $($i+1)/30)"
        Start-Sleep -Seconds 30
    }
}
if (-not $dnsOk) {
    Write-Stamp "‚ùå DNS n√£o propagou, verifique manualmente."
}

# 3Ô∏è‚É£ Monitoramento cont√≠nuo e alertas WhatsApp
function Check-Site {
    try {
        $req = Invoke-WebRequest "https://www.$Domain" -UseBasicParsing -TimeoutSec 10
        if ($req.StatusCode -eq 200) {
            Write-Stamp "‚úÖ Site online."
            return $true
        }
    } catch {
        Write-Stamp "‚ö†Ô∏è Site offline. Enviando alerta WhatsApp..."
        Send-WhatsAppAlert "üö® Alerta: O site PecuariaTech caiu!"
        return $false
    }
}

function Send-WhatsAppAlert($Message) {
    $Url = "https://graph.facebook.com/v17.0/$PhoneNumberId/messages"
    $Header = @{ "Authorization" = "Bearer $WhatsAppToken"; "Content-Type" = "application/json" }
    $Body = @{
        messaging_product = "whatsapp"
        to = $To
        type = "text"
        text = @{ body = $Message }
    } | ConvertTo-Json -Depth 3
    try {
        Invoke-RestMethod -Method Post -Uri $Url -Headers $Header -Body $Body
        Write-Stamp "‚úÖ Mensagem enviada com sucesso!"
    } catch {
        Write-Stamp "‚ùå Falha ao enviar mensagem WhatsApp."
    }
}

# 4Ô∏è‚É£ Fun√ß√£o GPS (exemplo j√° integrado)
function Start-GPSIntegration {
    Write-Stamp "üì° Integrando GPS em tempo real..."
    # Aqui voc√™ pode adicionar a l√≥gica existente do seu GPS
    # Por exemplo, leitura de coordenadas do Supabase e atualiza√ß√£o no mapa
}

# 5Ô∏è‚É£ Loop cont√≠nuo
Start-GPSIntegration
while ($true) {
    Check-Site
    Start-Sleep -Seconds 60
}
