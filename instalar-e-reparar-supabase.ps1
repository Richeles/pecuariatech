# ============================================================
# Script: instalar-e-reparar-supabase.ps1
# Autor: Richeles + GPT-5
# Descri√ß√£o: Cria a tabela logs_reparo, aplica RLS, testa API REST e executa o reparo autom√°tico
# ============================================================

Write-Host "üöÄ Iniciando instala√ß√£o da tabela logs_reparo e reparo autom√°tico..." -ForegroundColor Cyan

# === CONFIGURA√á√ïES ===
$pasta = "C:\Users\Administrador\pecuariatech"
$SUPABASE_URL = "https://kpzzekflqpoeccnqfkng.supabase.co"
$SUPABASE_SERVICE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtwenpla2ZscXBvZWNjbnFma25nIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MDgwNzE1MiwiZXhwIjoyMDY2MzgzMTUyfQ.8zy_xc93iJVdrIPrdP-iy8XN9GlVWkE0epmrguca3iA"

# === SQL CORRIGIDO (compat√≠vel com PostgreSQL 15+) ===
$sql = @"
CREATE TABLE IF NOT EXISTS public.logs_reparo (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  data_execucao TIMESTAMPTZ DEFAULT now(),
  arquivos_verificados INT,
  arquivos_corrigidos INT,
  arquivos_padronizados INT,
  mensagem TEXT,
  sucesso BOOLEAN DEFAULT TRUE
);

ALTER TABLE public.logs_reparo ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Permitir insercoes via API" ON public.logs_reparo;

CREATE POLICY "Permitir insercoes via API"
ON public.logs_reparo
FOR INSERT
TO public
WITH CHECK (true);
"@

# === EXECUTAR SQL VIA API ===
try {
    Invoke-RestMethod `
        -Uri "$SUPABASE_URL/sql/v1" `
        -Method Post `
        -Headers @{
            "apikey" = $SUPABASE_SERVICE_KEY
            "Authorization" = "Bearer $SUPABASE_SERVICE_KEY"
            "Content-Type" = "application/json"
        } `
        -Body (@{ query = $sql } | ConvertTo-Json)

    Write-Host "‚úÖ Tabela logs_reparo criada e pol√≠tica aplicada com sucesso!" -ForegroundColor Green
}
catch {
    Write-Host "‚ùå Erro ao criar tabela: $($_.Exception.Message)" -ForegroundColor Red
}

# === TESTAR ENDPOINT REST ===
try {
    $testBody = @{
        arquivos_verificados = 5
        arquivos_corrigidos = 1
        arquivos_padronizados = 4
        mensagem = "Teste de integra√ß√£o ap√≥s instala√ß√£o"
        sucesso = $true
    } | ConvertTo-Json

    Invoke-RestMethod `
        -Uri "$SUPABASE_URL/rest/v1/logs_reparo" `
        -Method Post `
        -Headers @{
            "apikey" = $SUPABASE_SERVICE_KEY
            "Authorization" = "Bearer $SUPABASE_SERVICE_KEY"
            "Content-Type" = "application/json"
            "Prefer" = "return=minimal"
        } `
        -Body $testBody

    Write-Host "‚òÅÔ∏è Endpoint REST ativo e inser√ß√£o de teste bem-sucedida!" -ForegroundColor Green
}
catch {
    Write-Host "‚ö†Ô∏è Erro ao testar endpoint REST: $($_.Exception.Message)" -ForegroundColor Yellow
}

# === EXECUTAR SCRIPT DE REPARO ===
if (Test-Path "$pasta\reparar-bom-v4.1.ps1") {
    Write-Host "`nüß© Executando reparo autom√°tico (reparar-bom-v4.1.ps1)..." -ForegroundColor Cyan
    & "$pasta\reparar-bom-v4.1.ps1"
} else {
    Write-Host "‚ö†Ô∏è Script reparar-bom-v4.1.ps1 n√£o encontrado." -ForegroundColor Red
}

Write-Host "`nüèÅ Instala√ß√£o e reparo conclu√≠dos." -ForegroundColor Cyan
Write-Host "üí° Verifique no Supabase ‚Üí Table Editor ‚Üí logs_reparo para confirmar a inser√ß√£o." -ForegroundColor White
