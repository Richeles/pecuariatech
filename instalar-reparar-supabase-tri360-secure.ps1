Write-Host "üî∫ Sistema Triangular 360¬∞ ‚Äî Vers√£o Segura Iniciada..." -ForegroundColor Cyan

# ===================== üîê CRIPTOGRAFIA DE SENHA =====================
$senhaArquivo = "$env:APPDATA\supabase_cred.key"
if (-not (Test-Path $senhaArquivo)) {
    Write-Host "üîë Nenhuma senha armazenada ‚Äî criando credencial segura..." -ForegroundColor Yellow
    $senha = Read-Host "Digite sua senha do banco Supabase (ex: 36@Artropodes)" -AsSecureString
    $senha | ConvertFrom-SecureString | Out-File $senhaArquivo
    Write-Host "‚úÖ Senha criptografada salva com seguran√ßa em: $senhaArquivo"
} else {
    Write-Host "üîê Senha segura j√° existente ‚Äî carregando..."
    $senha = Get-Content $senhaArquivo | ConvertTo-SecureString
}

# Converte senha criptografada para texto puro em tempo de execu√ß√£o (mem√≥ria apenas)
$BSTR = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($senha)
$senhaPura = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($BSTR)
$senhaCodificada = [uri]::EscapeDataString($senhaPura)

# ===================== üåê CONFIGURA√á√ÉO BASE =====================
$DB_URL = "db.kpzzekflqpoeccnqfkng.supabase.co"
$PSQL_PATH = "C:\Program Files\PostgreSQL\17\bin\psql.exe"
$LOG_FILE = "C:\Users\Administrador\pecuariatech\tri360_secure_log.txt"

# ===================== üß† 1Ô∏è‚É£ VERIFICA√á√ÉO DE AMBIENTE =====================
Write-Host "üß† [1/4] Diagn√≥stico inicial..."
if (-not (Test-Path $PSQL_PATH)) {
    Write-Host "‚ö†Ô∏è Cliente PostgreSQL n√£o encontrado. Instalando..." -ForegroundColor Yellow
    winget install --source winget PostgreSQL.PostgreSQL.17
} else {
    Write-Host "‚úÖ Cliente PostgreSQL detectado."
}
$env:PATH += ";C:\Program Files\PostgreSQL\17\bin"

# ===================== üåç 2Ô∏è‚É£ TESTE DE CONEX√ÉO =====================
Write-Host "üåê [2/4] Testando conex√£o com Supabase..."
$connectionString = "postgresql://postgres:$senhaCodificada@$DB_URL:5432/postgres"
try {
    $test = & $PSQL_PATH $connectionString -c "SELECT version();" 2>&1
    if ($test -match "PostgreSQL") {
        Write-Host "‚úÖ Conex√£o estabelecida com Supabase."
    } else {
        throw "Falha ao conectar. Detalhes: $test"
    }
}
catch {
    Write-Host "‚ùå Erro de conex√£o com Supabase. Verifique credenciais." -ForegroundColor Red
    Add-Content $LOG_FILE "[$(Get-Date)] Falha de conex√£o: $_"
    exit
}

# ===================== üß© 3Ô∏è‚É£ REPARO E CRIA√á√ÉO DE TABELA =====================
Write-Host "üß© [3/4] Verificando e criando tabela logs_reparo..."
$sql = @"
create table if not exists public.logs_reparo (
  id bigint generated by default as identity primary key,
  data_execucao timestamptz default now(),
  arquivos_verificados int,
  arquivos_corrigidos int,
  arquivos_padronizados int,
  mensagem text,
  sucesso boolean default true
);
alter table public.logs_reparo enable row level security;
drop policy if exists "Permitir insercoes via API" on public.logs_reparo;
create policy "Permitir insercoes via API"
on public.logs_reparo
for insert
to public
with check (true);
"@
& $PSQL_PATH $connectionString -c $sql
Write-Host "‚úÖ Tabela logs_reparo verificada e funcional." -ForegroundColor Green

# ===================== üßæ 4Ô∏è‚É£ LOGS E VALIDA√á√ÉO FINAL =====================
$mensagem = "Execu√ß√£o Tri360 Secure completa ‚Äî conex√£o e estrutura v√°lidas."
$hash = (Get-FileHash $LOG_FILE -Algorithm SHA256).Hash
Add-Content $LOG_FILE "[$(Get-Date)] $mensagem | Hash: $hash"
Write-Host "üìÅ Log seguro salvo em: $LOG_FILE" -ForegroundColor Yellow

Write-Host "üî∫ Sistema Triangular 360¬∞ ‚Äî Modo Seguro finalizado com sucesso." -ForegroundColor Cyan
