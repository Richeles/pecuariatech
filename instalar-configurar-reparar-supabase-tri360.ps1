Write-Host "üî∫ Sistema Triangular 360¬∞ ‚Äî Autorreparo Supabase iniciado..." -ForegroundColor Cyan

# ===================== CONFIGURA√á√ÉO BASE =====================
$SENHA = "36@Artropodes"
$SENHA_URL = "36%40Artropodes"
$DB_URL = "db.kpzzekflqpoeccnqfkng.supabase.co"
$PSQL_PATH = "C:\Program Files\PostgreSQL\17\bin\psql.exe"
$LOG_FILE = "C:\Users\Administrador\pecuariatech\tri360_log.txt"

# ===================== 1Ô∏è‚É£ VERIFICA√á√ÉO =====================
Write-Host "üß† [1/4] Diagn√≥stico inicial..."
if (-not (Test-Path $PSQL_PATH)) {
    Write-Host "‚ö†Ô∏è Cliente PostgreSQL n√£o encontrado. Instalando..." -ForegroundColor Yellow
    winget install --source winget PostgreSQL.PostgreSQL.17
} else {
    Write-Host "‚úÖ Cliente PostgreSQL detectado."
}

# Testa PATH
$env:PATH += ";C:\Program Files\PostgreSQL\17\bin"

# ===================== 2Ô∏è‚É£ TESTE DE CONEX√ÉO =====================
Write-Host "üåê [2/4] Testando conex√£o com Supabase..."
$connectionString = "postgresql://postgres:$SENHA_URL@$DB_URL:5432/postgres"
try {
    $test = & $PSQL_PATH $connectionString -c "SELECT version();" 2>&1
    if ($test -match "PostgreSQL") {
        Write-Host "‚úÖ Conex√£o estabelecida com Supabase."
    } else {
        throw "Falha ao conectar. Detalhes: $test"
    }
}
catch {
    Write-Host "‚ùå Erro na conex√£o com o Supabase. Verifique a senha ou internet." -ForegroundColor Red
    Add-Content $LOG_FILE "[$(Get-Date)] Falha de conex√£o: $_"
    exit
}

# ===================== 3Ô∏è‚É£ REPARO E CRIA√á√ÉO =====================
Write-Host "üß© [3/4] Criando tabela logs_reparo..."
$sql = @"
create table if not exists public.logs_reparo (
  id bigint generated by default as identity primary key,
  data_execucao timestamptz default now(),
  arquivos_verificados int,
  arquivos_corrigidos int,
  arquivos_padronizados int,
  mensagem text,
  sucesso boolean default true
);
alter table public.logs_reparo enable row level security;
drop policy if exists "Permitir insercoes via API" on public.logs_reparo;
create policy "Permitir insercoes via API"
on public.logs_reparo
for insert
to public
with check (true);
"@

try {
    & $PSQL_PATH $connectionString -c $sql
    Write-Host "‚úÖ Tabela logs_reparo criada e configurada." -ForegroundColor Green
}
catch {
    Write-Host "‚ùå Falha ao criar tabela no Supabase." -ForegroundColor Red
    Add-Content $LOG_FILE "[$(Get-Date)] Erro de SQL: $_"
}

# ===================== 4Ô∏è‚É£ LOG E SINCRONIZA√á√ÉO =====================
Write-Host "üì° [4/4] Registrando log de opera√ß√£o..."
$mensagem = "Execu√ß√£o Triangular360 finalizada com sucesso"
Add-Content $LOG_FILE "[$(Get-Date)] $mensagem"

Write-Host "‚úÖ Processo completo conclu√≠do!"
Write-Host "üìÅ Log salvo em: $LOG_FILE" -ForegroundColor Yellow
Write-Host "üî∫ Sistema Triangular 360¬∞ conclu√≠do com estabilidade total." -ForegroundColor Cyan
